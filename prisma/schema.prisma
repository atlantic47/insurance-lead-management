// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  MANAGER
  AGENT
}

enum LeadStatus {
  NEW
  CONTACTED
  ENGAGED
  QUALIFIED
  PROPOSAL_SENT
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
  FOLLOW_UP
}

enum LeadSource {
  MANUAL
  API
  CHATBOT
  EMAIL
  WHATSAPP
  SOCIAL_MEDIA
  WEBSITE
  REFERRAL
}

enum InsuranceType {
  LIFE
  HEALTH
  AUTO
  HOME
  BUSINESS
  TRAVEL
  OTHER
}

enum CommunicationChannel {
  EMAIL
  WHATSAPP
  PHONE
  SMS
  IN_APP
  SOCIAL_MEDIA
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskType {
  FOLLOW_UP
  CALL
  MEETING
  EMAIL
  PROPOSAL
  OTHER
}

// Multi-Tenancy Support
model Tenant {
  id             String    @id @default(uuid())
  name           String    // Agency/Organization name
  subdomain      String    @unique // e.g., "acme" for acme.insurancecrm.com
  domain         String?   @unique // Custom domain support
  plan           String    @default("free") // free, basic, pro, enterprise
  status         String    @default("active") // trial, active, suspended, cancelled
  maxUsers       Int       @default(10)
  maxLeads       Int       @default(10000)
  settings       Json?     // Tenant-specific settings

  // Billing
  subscriptionId String?   // Flutterwave subscription ID
  trialEndsAt    DateTime? // Trial expiration date

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  users              User[]
  leads              Lead[]
  clients            Client[]
  tasks              Task[]
  products           Product[]
  campaigns          Campaign[]
  communications     Communication[]
  contactGroups      ContactGroup[]
  campaignTemplates  CampaignTemplate[]
  aiConversations    AIConversation[]
  tickets            Ticket[]
  chatMessages       ChatMessage[]
  emailMessages      EmailMessage[]
  aiTrainingData     AITrainingData[]
  emailCredentials   EmailCredential[]
  whatsappCredentials WhatsAppCredential[]

  @@map("tenants")
}

// Email Credential Model - Multiple email accounts per tenant
model EmailCredential {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String   // User-friendly name (e.g., "Support Email", "Sales Email")
  host        String   // SMTP host
  port        Int      // SMTP port
  secure      Boolean  @default(true) // Use SSL/TLS
  user        String   // SMTP username/email
  pass        String   // Encrypted password
  fromEmail   String   // From email address
  fromName    String?  // From name

  isDefault   Boolean  @default(false) // Default email for sending
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("email_credentials")
  @@index([tenantId])
  @@index([tenantId, isDefault])
}

// WhatsApp Credential Model - Multiple WhatsApp numbers per tenant
model WhatsAppCredential {
  id                  String   @id @default(uuid())
  tenantId            String
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name                String   // User-friendly name (e.g., "Main Support", "Sales Line")
  phoneNumber         String   // Display phone number (e.g., "+1234567890")
  phoneNumberId       String   // Meta Phone Number ID
  businessAccountId   String   // Meta Business Account ID
  accessToken         String   // Encrypted access token
  appSecret           String?  // Encrypted app secret for webhook validation
  webhookVerifyToken  String   // Webhook verification token (auto-generated on create)
  webhookUrl          String   // Unique webhook URL for this credential (auto-generated on create)

  isDefault           Boolean  @default(false) // Default number for sending
  isActive            Boolean  @default(true)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("whatsapp_credentials")
  @@index([tenantId])
  @@index([tenantId, isDefault])
  @@index([phoneNumberId])
}

// Core Models
model User {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String
  firstName   String
  lastName    String
  phone       String?
  role        UserRole @default(AGENT)
  isActive    Boolean  @default(true)
  lastLogin   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenancy
  tenantId      String?
  tenant        Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  isSuperAdmin  Boolean  @default(false) // System-wide admin

  // Relations
  assignedLeads     Lead[]
  communications    Communication[]
  tasks             Task[]
  auditLogs         AuditLog[]
  aiConversations   AIConversation[]
  contactGroups     ContactGroup[]     @relation("ContactGroupCreator")
  campaigns         Campaign[]         @relation("CampaignCreator")
  campaignTemplates CampaignTemplate[] @relation("TemplateCreator")
  notifications     Notification[]
  assignedTickets   Ticket[]           @relation("AssignedTickets")
  createdTickets    Ticket[]           @relation("CreatedTickets")

  @@index([tenantId])
  @@map("users")
}

model Company {
  id        String   @id @default(uuid())
  name      String
  address   String?
  phone     String?
  email     String?
  website   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clients   Client[]

  @@map("companies")
}

model Lead {
  id                    String         @id @default(uuid())
  source                LeadSource
  status                LeadStatus     @default(NEW)
  insuranceType         InsuranceType
  urgency               Int            @default(1) // 1-5 scale
  score                 Float          @default(0) // Lead scoring
  manualScore           Float?         // Manual override
  
  // Contact Information
  firstName             String
  lastName              String
  email                 String?
  phone                 String?
  alternatePhone        String?
  preferredContact      CommunicationChannel?
  
  // Location
  address               String?
  city                  String?
  state                 String?
  zipCode               String?
  country               String?       @default("US")
  
  // Inquiry Details
  inquiryDetails        String?       @db.Text
  budget                Decimal?      @db.Decimal(10, 2)
  expectedCloseDate     DateTime?
  
  // Assignment and Tracking
  assignedUserId        String?
  assignedUser          User?         @relation(fields: [assignedUserId], references: [id])

  // Multi-tenancy
  tenantId              String
  tenant                Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  lastContactedAt       DateTime?

  // Relations
  communications        Communication[]
  tasks                 Task[]
  client                Client?
  aiConversations       AIConversation[]
  leadProducts          LeadProduct[]
  chatMessages          ChatMessage[]
  emailMessages         EmailMessage[]
  contactGroups         LeadContactGroup[]
  tickets               Ticket[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, assignedUserId])
  @@map("leads")
}

model Communication {
  id          String               @id @default(uuid())
  channel     CommunicationChannel
  direction   String               // INBOUND, OUTBOUND
  subject     String?
  content     String               @db.Text
  metadata    Json?                // Store channel-specific data
  isRead      Boolean              @default(false)
  sentAt      DateTime             @default(now())
  
  // Relations
  leadId      String
  lead        Lead                 @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?                @relation(fields: [userId], references: [id])

  // Multi-tenancy
  tenantId    String
  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@index([tenantId])
  @@map("communications")
}

model Product {
  id              String    @id @default(uuid())
  name            String
  description     String?   @db.Text
  type            InsuranceType
  basePrice       Decimal?  @db.Decimal(10, 2)
  features        Json?     // Store product features as JSON
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Multi-tenancy
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  clients         Client[]
  leadProducts    LeadProduct[]

  @@index([tenantId])
  @@map("products")
}

model LeadProduct {
  id        String   @id @default(uuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  interest  Int      @default(1) // 1-5 scale
  notes     String?  @db.Text
  createdAt DateTime @default(now())

  @@unique([leadId, productId])
  @@map("lead_products")
}

model Client {
  id              String    @id @default(uuid())
  
  // Lead conversion
  leadId          String?   @unique
  lead            Lead?     @relation(fields: [leadId], references: [id])
  
  // Client Information
  firstName       String
  lastName        String
  email           String?
  phone           String?
  dateOfBirth     DateTime?
  
  // Company relationship
  companyId       String?
  company         Company?  @relation(fields: [companyId], references: [id])
  
  // Policy Information
  productId       String?
  product         Product?  @relation(fields: [productId], references: [id])
  policyNumber    String?   @unique
  premium         Decimal?  @db.Decimal(10, 2)
  commission      Decimal?  @db.Decimal(10, 2)
  startDate       DateTime?
  endDate         DateTime?
  renewalDate     DateTime?
  
  // Status
  isActive        Boolean   @default(true)

  // Multi-tenancy
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([tenantId])
  @@map("clients")
}

model Task {
  id          String     @id @default(uuid())
  title       String
  description String?    @db.Text
  type        TaskType
  status      TaskStatus @default(PENDING)
  priority    Int        @default(1) // 1-5 scale
  dueDate     DateTime?
  completedAt DateTime?
  
  // Relations
  leadId      String?
  lead        Lead?      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  assignedUserId String
  assignedUser   User    @relation(fields: [assignedUserId], references: [id])

  // Multi-tenancy
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([tenantId])
  @@index([tenantId, assignedUserId])
  @@map("tasks")
}

model AIConversation {
  id            String   @id @default(uuid())
  type          String   // CHATBOT, SENTIMENT_ANALYSIS, AUTO_RESPONSE
  input         String   @db.Text
  output        String   @db.Text
  confidence    Float?   // AI confidence score
  metadata      Json?    // Store AI-specific data
  isEscalated   Boolean  @default(false)
  escalatedAt   DateTime?
  
  // Relations
  leadId        String?
  lead          Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  chatMessages  ChatMessage[]

  // Multi-tenancy
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())

  @@index([tenantId])
  @@map("ai_conversations")
}

model ChatMessage {
  id                String   @id @default(uuid())
  content           String   @db.Text
  sender            String   // CUSTOMER, AI_ASSISTANT, HUMAN_AGENT
  platform          String   // WHATSAPP, EMAIL, SMS
  platformMessageId String?  // External platform message ID
  metadata          Json?    // Platform-specific data (phone numbers, email addresses, etc.)
  isRead            Boolean  @default(false)
  readAt            DateTime?

  // Relations
  conversationId    String?
  conversation      AIConversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  leadId            String?
  lead              Lead?           @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Multi-tenancy - CRITICAL FOR SECURITY
  tenantId          String
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([tenantId])
  @@map("chat_messages")
}

model EmailMessage {
  id          String   @id @default(uuid())
  subject     String
  content     String   @db.LongText
  fromEmail   String
  toEmail     String
  ccEmails    String?  @db.Text // JSON array of CC emails
  bccEmails   String?  @db.Text // JSON array of BCC emails
  messageId   String?  @unique  // External email message ID
  inReplyTo   String?  // Message ID this is replying to
  threadId    String?  // Email thread identifier
  isRead      Boolean  @default(false)
  readAt      DateTime?
  direction   String   // INBOUND, OUTBOUND

  // Relations
  leadId      String?
  lead        Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Multi-tenancy - CRITICAL FOR SECURITY
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@map("email_messages")
}

model AITrainingData {
  id           String    @id @default(uuid())
  type         String    // 'file' or 'url'
  name         String    // filename or URL
  content      String    @db.LongText
  instructions String    @db.Text
  status       String    @default("processing") // 'processing', 'processed', 'error'
  error        String?   @db.Text
  metadata     Json?     // Additional data (file info, URL info, etc.)
  processedAt  DateTime?

  // Multi-tenancy - CRITICAL FOR SECURITY
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([tenantId])
  @@map("ai_training_data")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity    String   // User, Lead, Communication, etc.
  entityId  String
  oldValue  Json?
  newValue  Json?
  ipAddress String?
  userAgent String?
  
  // Relations
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

enum ContactGroupType {
  WHATSAPP
  EMAIL
  BOTH
}

enum CampaignType {
  WHATSAPP
  EMAIL
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  COMPLETED
  FAILED
  CANCELLED
}

model ContactGroup {
  id          String           @id @default(uuid())
  name        String
  description String?
  type        ContactGroupType
  color       String?          // For UI display (e.g., "#3B82F6")

  // Relations
  leads       LeadContactGroup[]
  campaigns   Campaign[]
  createdById String
  createdBy   User             @relation("ContactGroupCreator", fields: [createdById], references: [id])

  // Multi-tenancy
  tenantId    String
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([tenantId])
  @@map("contact_groups")
}

// Junction table for many-to-many relationship between Leads and ContactGroups
model LeadContactGroup {
  id             String       @id @default(uuid())
  leadId         String
  lead           Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  contactGroupId String
  contactGroup   ContactGroup @relation(fields: [contactGroupId], references: [id], onDelete: Cascade)

  addedAt        DateTime     @default(now())

  @@unique([leadId, contactGroupId])
  @@map("lead_contact_groups")
}

model CampaignTemplate {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        CampaignType // WHATSAPP or EMAIL

  // Email template fields
  subject     String?      // For email only
  content     String       @db.LongText // For email: plain text content with {firstName}, {lastName} variables
  htmlContent String?      @db.LongText // For email: HTML content with inline CSS styling
  variables   Json?        // Available variables for email template (e.g., {firstName}, {lastName})
  isHtml      Boolean      @default(false) // Whether to use HTML content or plain text

  // WhatsApp Business API template fields
  whatsappTemplateName String?     // Meta-approved template name (e.g., "welcome_message")
  whatsappLanguageCode String?     // Language code (e.g., "en", "es")
  whatsappComponents   Json?       // Template structure with header, body, footer, buttons
  whatsappParameters   Json?       // Mapping for numbered placeholders {{1}}, {{2}} to lead fields

  // Relations
  createdById String
  createdBy   User         @relation("TemplateCreator", fields: [createdById], references: [id])
  campaigns   Campaign[]

  // Multi-tenancy
  tenantId    String
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([tenantId])
  @@map("campaign_templates")
}

model Campaign {
  id                String         @id @default(uuid())
  name              String
  description       String?
  type              CampaignType   // WHATSAPP or EMAIL
  status            CampaignStatus @default(DRAFT)

  // Template
  templateId        String?
  template          CampaignTemplate? @relation(fields: [templateId], references: [id])

  // Custom content (if not using template)
  subject           String?        // For email
  content           String?        @db.LongText

  // Target audience
  contactGroupId    String
  contactGroup      ContactGroup   @relation(fields: [contactGroupId], references: [id])

  // Scheduling
  scheduledAt       DateTime?
  sentAt            DateTime?
  completedAt       DateTime?

  // Stats
  totalRecipients   Int            @default(0)
  sentCount         Int            @default(0)
  failedCount       Int            @default(0)
  deliveredCount    Int            @default(0)
  openedCount       Int            @default(0)
  clickedCount      Int            @default(0)

  // Relations
  createdById       String
  createdBy         User           @relation("CampaignCreator", fields: [createdById], references: [id])

  // Multi-tenancy
  tenantId          String
  tenant            Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([tenantId])
  @@map("campaigns")
}

// System Settings Model - REMOVED
// All settings now stored per-tenant in tenant.settings.credentials
// This ensures complete tenant isolation with no shared/global settings

// Notifications Model
model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // LEAD_ASSIGNED, TASK_DUE, AI_ESCALATION, NEW_LEAD, TASK_COMPLETED
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false)
  metadata  Json?    // Additional data (leadId, taskId, etc.)
  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@map("notifications")
}

enum TicketStatus {
  NEW
  IN_PROGRESS
  PENDING
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Ticket {
  id              String         @id @default(uuid())
  title           String
  description     String         @db.Text
  status          TicketStatus   @default(NEW)
  priority        TicketPriority @default(MEDIUM)

  // Relations
  leadId          String?
  lead            Lead?          @relation(fields: [leadId], references: [id], onDelete: SetNull)

  assignedUserId  String?
  assignedUser    User?          @relation("AssignedTickets", fields: [assignedUserId], references: [id])

  createdById     String
  createdBy       User           @relation("CreatedTickets", fields: [createdById], references: [id])

  // Multi-tenancy
  tenantId        String
  tenant          Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  tags            Json?          // Array of tags
  dueDate         DateTime?
  resolvedAt      DateTime?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([tenantId])
  @@index([status])
  @@index([assignedUserId])
  @@map("tickets")
}